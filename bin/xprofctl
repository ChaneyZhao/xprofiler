#!/usr/bin/env node

'use strict';

const yargs = require('yargs');
const xctl = require('../lib/xctl');
const utils = require('../lib/utils');

const args = yargs
  .usage('$0 <action> -p <pid> [-t profiling_time]')
  // commands
  .command('start_cpu_profiling', '生成 cpuprofile')
  .command('start_heap_profiling', '生成 heapprofile')
  .command('heapdump', '生成 heapsnapshot')
  .command('check_version', '获取 xprofiler 插件版本号')
  .command('get_config', '获取 xprofiler 配置')
  // pid
  .describe('p', '进程 pid')
  .alias('p', 'pid')
  .demandOption(['p'])
  // profiling time
  .describe('t', 'profiling 时长')
  .alias('t', 'profiling_time')
  .number('t')
  // examples
  .example('$0 start_cpu_profiling -p 29156 -t 30', '触发进程 29156 生成 30s 的 cpu 采样')
  .example('$0 start_cpu_profiling -p 29156', '默认生成 5min 的 cpu 采样')
  .example('$0 heapdump -p 29156', '触发进程 29156 生成堆快照')
  // common
  .alias('v', 'version')
  .alias('h', 'help')
  .help('h')
  .epilog('copyright 2019')
  .argv;


// get args
const action = args['_'][0];
const pid = args['pid'];
const profilingTime = args['profiling_time'];

// send message
const options = {};
if (profilingTime !== null && !isNaN(profilingTime)) {
  options.profiling_time = profilingTime;
}

xctl(pid, action, options)
  .then(data => {
    if (data.ok) {
      data = data.data;
      switch (action) {
      case 'check_version':
        console.log(`X-Profiler 插件版本号(pid ${pid}): v${data.version}`);
        break;
      case 'get_config':
        console.log(`X-Profiler 当前配置(pid ${pid}):\n${utils.printConfig(data)}`);
        break;
      default:
        console.log(`未知操作 ${action}: ${JSON.stringify(data)}`);
      }
    } else {
      console.log(`执行命令失败: ${data.message || JSON.stringify(data)}`);
    }
  })
  .catch(err => {
    console.log(`操作出错: ${err}`);
  });